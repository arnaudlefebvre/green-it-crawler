# ğŸŒ± Green IT KPI Crawler

Un outil d'analyse automatisÃ© pour mesurer l'impact environnemental et les performances web de vos applications, basÃ© sur les mÃ©triques GreenIT et RWEB.

## ğŸ¯ Objectifs du projet

Ce projet permet d'**automatiser l'audit environnemental** de vos sites web en mesurant :

- **ğŸ“Š MÃ©triques techniques** : requÃªtes, taille DOM, compression, minification, cache, etc.
- **ğŸŒ Impact environnemental** : Ã©missions COâ‚‚, consommation d'Ã©nergie et d'eau (mix Ã©nergÃ©tique franÃ§ais)
- **âš¡ Performance web** : lazy loading, formats d'images optimisÃ©s, protocoles HTTP
- **ğŸ”’ SÃ©curitÃ©** : HSTS, cookies, domaines externes

### Pourquoi c'est important ?

- **RÃ©duction de l'empreinte carbone** : Chaque Ko Ã©conomisÃ© rÃ©duit les Ã©missions COâ‚‚
- **ConformitÃ© rÃ©glementaire** : Anticipation des futures rÃ©glementations environnementales
- **Performance utilisateur** : Sites plus rapides = meilleure UX
- **CoÃ»ts d'infrastructure** : Moins de bande passante = Ã©conomies
- **Image de marque** : Engagement environnemental visible

## ğŸš€ Installation

### PrÃ©requis
- Node.js 18+ 
- npm ou yarn

### Installation des dÃ©pendances

```bash
# Cloner le projet
git clone <repository-url>
cd green-it-crawler

# Installer les dÃ©pendances
npm install

# Installer les navigateurs Playwright
npx playwright install --with-deps
```

## âš™ï¸ Configuration

CrÃ©ez un fichier `config.yml` Ã  la racine du projet :

### Configuration basique

```yaml
# Configuration minimale
targets:
- product: "Mon Site Web"
  pages:
  - name: "Accueil"
    url: "https://monsite.com"
  - name: "Ã€ propos"
    url: "https://monsite.com/about"

# Configuration runtime
runtime:
  headless: true
  ignoreHTTPSErrors: false
  navigationTimeoutMs: 60000
  settleAfterMs: 2500

# Impact environnemental (mix Ã©nergÃ©tique franÃ§ais)
impact:
  kWhPerGB: 0.81
  gridIntensity_g_per_kWh: 79    # France: 79g COâ‚‚/kWh
  waterIntensity_L_per_kWh: 0.8  # France: 0.8L/kWh
```

### Configuration avancÃ©e avec authentification

```yaml
# Configuration avec login automatique
login:
  url: "https://monsite.com/login"
  usernameSelector: "#username"
  passwordSelector: "#password"
  submitSelector: "button[type=submit]"
  usernameEnv: "SITE_USER"      # Variable d'environnement
  passwordEnv: "SITE_PASS"      # Variable d'environnement
  waitFor: "networkidle"
  timeoutMs: 45000

# Ou utiliser une session capturÃ©e
login:
  storageStatePath: "out/auth/storageState.json"

targets:
- product: "Application PrivÃ©e"
  pages:
  # Pages publiques (pas d'auth requise)
  - name: "Landing"
    url: "https://app.com/landing"
  
  # Pages privÃ©es (auth requise)
  - name: "Dashboard"
    url: "https://app.com/dashboard"
    auth: "required"
    weight: 2  # Poids plus important pour le calcul global
  
  - name: "Profile"
    url: "https://app.com/profile"
    requiresAuth: true

# Configuration KPI avec impact environnemental
kpi:
  weights:
    # MÃ©triques traditionnelles (90%)
    requests: 0.35
    transferKB: 0.20
    domSize: 0.15
    uniqueDomains: 0.08
    compressedPct: 0.04
    minifiedPct: 0.04
    
    # Impact environnemental (10%)
    co2Impact: 0.04      # COâ‚‚ (le plus important)
    energyImpact: 0.03   # Ã‰nergie
    waterImpact: 0.02    # Eau
    dataImpact: 0.01     # Volume de donnÃ©es
    
    # Autres mÃ©triques
    inlineStyles: 0.02
    inlineScripts: 0.02
    cssFiles: 0.015
    jsFiles: 0.015
    # ... autres poids

  thresholds:
    # Seuils environnementaux (contexte franÃ§ais)
    co2_g: [0.5, 1.0, 2.0, 4.0]           # g COâ‚‚ par page
    energy_kWh: [0.0006, 0.0012, 0.0025, 0.005]  # kWh par page
    water_cl: [0.05, 0.1, 0.2, 0.4]       # cL par page
    dataGB: [0.0005, 0.001, 0.002, 0.004] # GB transfÃ©rÃ©s
    
    # Seuils traditionnels
    requests: [27, 50, 80, 120]
    transferKB: [300, 800, 1500, 2500]
    domSize: [800, 1500, 2500, 4000]
    # ... autres seuils

  # Poids par page (optionnel)
  page_weights:
    "Mon Site Web":
      "Accueil": 3      # Page d'accueil plus importante
      "Ã€ propos": 1
    "Dashboard": 2      # Ou directement par nom de page

# Configuration cache
cache:
  minSeconds: 604800  # 7 jours minimum pour les assets statiques
```

### Configuration multi-produits

```yaml
targets:
- product: "Site Public"
  pages:
  - name: "Accueil"
    url: "https://public.monsite.com"

- product: "Application MÃ©tier"
  login:
    url: "https://app.monsite.com/login"
    usernameSelector: "#email"
    passwordSelector: "#password"
    submitSelector: ".login-btn"
    usernameEnv: "APP_USER"
    passwordEnv: "APP_PASS"
  pages:
  - name: "Dashboard"
    url: "https://app.monsite.com/dashboard"
    auth: "required"

- product: "API Documentation"
  pages:
  - name: "API Docs"
    url: "https://docs.monsite.com"
```

## ğŸƒâ€â™‚ï¸ Utilisation

### Commandes principales

```bash
# Analyse basique
npm run kpi

# Analyse avec session persistante
npm run kpi:session

# Version modulaire (recommandÃ©e)
npm run kpi:modular

# Avec paramÃ¨tres personnalisÃ©s
node src/main.js --config config.yml --out results

# Comparaison automatique avec la derniÃ¨re exÃ©cution
node src/main.js --config config.yml --out results --compare-latest
```

### Variables d'environnement pour l'authentification

```bash
# DÃ©finir les credentials (ne jamais les committer !)
export SITE_USER="mon.email@example.com"
export SITE_PASS="monmotdepasse"

# Ou dans un fichier .env (Ã  ajouter au .gitignore)
echo "SITE_USER=mon.email@example.com" >> .env
echo "SITE_PASS=monmotdepasse" >> .env

# Puis lancer l'analyse
npm run kpi:modular
```

## ğŸ” Gestion de l'authentification

### MÃ©thode 1 : Login automatique (form-fill) (recommandÃ©e)

Configuration dans `config.yml` :

```yaml
login:
  url: "https://monsite.com/login"
  usernameSelector: "#username"           # SÃ©lecteur CSS du champ email/username
  passwordSelector: "#password"           # SÃ©lecteur CSS du champ password
  submitSelector: "button[type=submit]"   # SÃ©lecteur CSS du bouton de connexion
  usernameEnv: "SITE_USER"               # Variable d'environnement pour l'username
  passwordEnv: "SITE_PASS"               # Variable d'environnement pour le password
  waitFor: "networkidle"                 # Attendre la fin des requÃªtes rÃ©seau
  timeoutMs: 45000                       # Timeout en millisecondes

# Pour des sÃ©lecteurs complexes (Shadow DOM, frameworks comme Vaadin)
login:
  url: "https://app.com/login"
  usernameSelectors:                     # Plusieurs sÃ©lecteurs possibles
    - "#username"
    - "css=vaadin-text-field[name='username'] >>> input"
  passwordSelectors:
    - "#password"  
    - "css=vaadin-password-field[name='password'] >>> input"
  submitSelector: "vaadin-button[theme='primary']"
```

### MÃ©thode 2 : Capture de session manuelle 

Plus fiable pour les authentifications complexes (2FA, CAPTCHA, etc.) :

```bash
# 1. Capturer une session en se connectant manuellement
npm run session:capture

# Ou avec paramÃ¨tres personnalisÃ©s
node capture-session.js \
  --url "https://monsite.com/login" \
  --out "out/auth/storageState.json" \
  --ignore-https-errors

# Optionnel : attendre un Ã©lÃ©ment spÃ©cifique aprÃ¨s login
node capture-session.js \
  --url "https://monsite.com/login" \
  --out "out/auth/storageState.json" \
  --wait-selector "#dashboard"

# Optionnel : attendre une URL spÃ©cifique
node capture-session.js \
  --url "https://monsite.com/login" \
  --out "out/auth/storageState.json" \
  --wait-url-contains "/dashboard"
```

Puis dans `config.yml` :

```yaml
login:
  storageStatePath: "out/auth/storageState.json"
```

### MÃ©thode 3 : Authentification par produit

Chaque produit peut avoir sa propre authentification :

```yaml
targets:
- product: "MySanteClair Web"
  login:
    storageStatePath: "out/auth/mysanteclair_storageState.json"
  pages:
  - name: "Dashboard"
    url: "https://services.santeclair.fr/dashboard"
    auth: "required"

- product: "Santeclair Solution"  
  login:
    url: "https://solution.santeclair.fr/login"
    usernameEnv: "STC_USER"
    passwordEnv: "STC_PASS"
    usernameSelector: "#email"
    passwordSelector: "#password"
    submitSelector: ".btn-login"
  pages:
  - name: "Admin"
    url: "https://solution.santeclair.fr/admin"
    requiresAuth: true
```

Les variables d'environnement suivent le pattern : `{PREFIX}_{PRODUCT}_USER` et `{PREFIX}_{PRODUCT}_PASS`

## ğŸ“Š RÃ©sultats et rapports

### Structure des fichiers gÃ©nÃ©rÃ©s

```
out/
â”œâ”€â”€ reports/
â”‚   â””â”€â”€ MonSiteWeb/
â”‚       â”œâ”€â”€ MonSiteWeb_Accueil_2025-09-18T12-34-56-789Z_report.md
â”‚       â”œâ”€â”€ MonSiteWeb_GLOBAL_2025-09-18T12-34-56-789Z.md
â”‚       â”œâ”€â”€ MonSiteWeb_RUN_2025-09-18T12-34-56-789Z.json
â”‚       â””â”€â”€ DIFF_MonSiteWeb_RUN_...vs_RUN_....md
â”œâ”€â”€ pages/
â”‚   â””â”€â”€ MonSiteWeb_Accueil_2025-09-18T12-34-56-789Z.html
â”œâ”€â”€ logs/
â”‚   â”œâ”€â”€ MonSiteWeb_Accueil_2025-09-18T12-34-56-789Z_responses.json
â”‚   â””â”€â”€ MonSiteWeb_Accueil_2025-09-18T12-34-56-789Z_jserrors.json
â”œâ”€â”€ auth/
â”‚   â””â”€â”€ storageState.json
â”œâ”€â”€ history.jsonl
â””â”€â”€ history.csv
```

### Types de rapports

1. **Rapport dÃ©taillÃ© par page** (`*_report.md`) :
   - Grade environnemental et KPI composite
   - Impact COâ‚‚, Ã©nergie, eau avec Ã©quivalences
   - MÃ©triques techniques dÃ©taillÃ©es
   - Conseils d'amÃ©lioration par indicateur
   - Liste des ressources problÃ©matiques

2. **Rapport global par produit** (`*_GLOBAL_*.md`) :
   - Score global pondÃ©rÃ©
   - SynthÃ¨se par page
   - MÃ©thode de calcul

3. **Comparaisons** (`DIFF_*.md`) :
   - Ã‰volution des scores entre deux exÃ©cutions
   - RÃ©gressions et amÃ©liorations
   - Changements d'impact environnemental

## ğŸ”„ Comparaison d'exÃ©cutions

```bash
# Comparaison automatique avec la derniÃ¨re exÃ©cution
node src/main.js --config config.yml --out out --compare-latest

# Comparaison manuelle entre deux exÃ©cutions spÃ©cifiques
node kpi-compare.cjs \
  --base out/reports/MonProduit/MonProduit_RUN_2025-09-16T....json \
  --head out/reports/MonProduit/MonProduit_RUN_2025-09-17T....json \
  --out out/reports/MonProduit
```

## ğŸ› ï¸ DÃ©veloppement

### Architecture modulaire

Le projet utilise une architecture modulaire pour faciliter la maintenance :

```
src/
â”œâ”€â”€ crawler/          # Navigation et collecte de donnÃ©es
â”œâ”€â”€ kpi/             # Calcul des mÃ©triques et scores
â”œâ”€â”€ reporting/       # GÃ©nÃ©ration des rapports
â”œâ”€â”€ utils/           # Utilitaires partagÃ©s
â””â”€â”€ main.js          # Orchestrateur principal
```

### Scripts de dÃ©veloppement

```bash
# Version originale (stable)
npm run kpi

# Version modulaire (dÃ©veloppement)
npm run kpi:modular

# Tests et validation
npm run kpi:modular -- --config config-test.yml
```

## ğŸ“ˆ MÃ©triques mesurÃ©es

### Impact environnemental (mix franÃ§ais)
- **COâ‚‚** : 79g COâ‚‚eq/kWh (vs 442g mondial)
- **Ã‰nergie** : Consommation en kWh
- **Eau** : 0.8L/kWh (efficacitÃ© nuclÃ©aire)
- **DonnÃ©es** : Volume transfÃ©rÃ©

### MÃ©triques techniques
- Nombre de requÃªtes HTTP
- Taille des pages (transfÃ©rÃ© vs dÃ©codÃ©)
- Taille du DOM
- Compression et minification
- Cache et cookies
- Formats d'images optimisÃ©s
- Lazy loading
- SÃ©curitÃ© (HSTS)

### Scores et grades
- **KPI composite** : 0-100 avec grade A-G
- **Grade environnemental** : A+ Ã  F
- **PondÃ©ration configurable** par mÃ©trique
- **Seuils adaptÃ©s** au contexte franÃ§ais

## ğŸ¤ Contribution

1. Fork le projet
2. CrÃ©er une branche feature (`git checkout -b feature/amelioration`)
3. Commit les changements (`git commit -am 'Ajout fonctionnalitÃ©'`)
4. Push vers la branche (`git push origin feature/amelioration`)
5. CrÃ©er une Pull Request

## ğŸ“„ Licence

Ce projet est sous licence [Apache2](LICENSE).

## ğŸ†˜ Support

- **Issues** : Signaler les bugs via GitHub Issues
- **Documentation** : Voir `src/README.md` pour l'architecture technique
- **Configuration** : Exemples dans `config-environmental-example.yml`